<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebAR Face Stylization</title>

  <!-- ‚úÖ MindAR for image tracking -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-three.prod.js"></script>

  <!-- ‚úÖ face-api.js ÁÄèË¶ΩÂô®Â∞àÁî®ÁâàÊú¨ (ÈÅøÂÖç exports ÈåØË™§) -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #output { z-index: 1; }
    #face-canvas { display: none; }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline width="640" height="480" style="display:none;"></video>
  <canvas id="output" width="640" height="480"></canvas>
  <img id="bg" src="b.jpg" style="display: none" />
  <canvas id="face-canvas" width="150" height="150" style="display:none;"></canvas>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video');
      const canvas = document.getElementById('output');
      const ctx = canvas.getContext('2d');
      const bgImg = document.getElementById('bg');
      const faceCanvas = document.getElementById('face-canvas');
      const faceCtx = faceCanvas.getContext('2d');

      let faceDetectionActive = false;

      async function initCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
          video.srcObject = stream;
          await new Promise(resolve => video.onloadedmetadata = resolve);
          console.log("üìπ Camera initialized successfully");
        } catch (err) {
          console.error("‚ùå Camera initialization failed:", err);
          alert("Unable to access camera. Please check your browser's permissions.");
        }
      }

      async function loadModels() {
        try {
          console.log("üîÑ Loading face-api models...");
          await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
          console.log("‚úÖ face-api models loaded successfully");
        } catch (err) {
          console.error("‚ùå Failed to load face-api models:", err);
        }
      }

      async function renderFrame() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (faceDetectionActive) {
          try {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            if (detections.length > 0) {
              ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
              for (const det of detections) {
                const { x, y, width, height } = det.box;
                faceCtx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
                faceCtx.drawImage(video, x, y, width, height, 0, 0, faceCanvas.width, faceCanvas.height);

                // Áπ™Ë£ΩÂÅµÊ∏¨Âà∞ÁöÑËáâÈÉ®ÂΩ±ÂÉè
                ctx.drawImage(video, x, y, width, height, x, y, width, height);
              }
            }
          } catch (e) {
            console.error("‚ùå Face detection failed:", e);
          }
        }
        requestAnimationFrame(renderFrame);
      }

      async function setupMindAR() {
        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
          container: document.body,
          imageTargetSrc: './a.mind',
          uiScanning: false,
          uiLoading: false
        });

        const { renderer, scene, camera } = mindarThree;
        const anchor = mindarThree.addAnchor(0);

        anchor.onTargetFound = () => {
          faceDetectionActive = true;
          console.log("üéØ a.jpg detected, enabling face detection");
        };

        anchor.onTargetLost = () => {
          faceDetectionActive = false;
          console.log("üîï a.jpg lost, disabling face detection");
        };

        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      }

      (async () => {
        try {
          console.log("üîÑ Initializing camera...");
          await initCamera();
          await loadModels();
          await setupMindAR();
          renderFrame();
        } catch (e) {
          console.error("‚ùå Initialization failed:", e);
        }
      })();
    });
  </script>
</body>
</html>
